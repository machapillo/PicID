<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨¼æ˜å†™çœŸãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <main class="container">
        <!-- Step 1: Size Selection -->
        <section id="size-selection-section" class="step-section active">
            <h2 class="section-title">1. ã‚µã‚¤ã‚ºã‚’é¸æŠ</h2>
            <div class="size-options">
                <button class="size-btn" data-width="30" data-height="40">å±¥æ­´æ›¸ (40x30mm)</button>
                <button class="size-btn" data-width="35" data-height="45">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ (45x35mm)</button>
                <button class="size-btn" data-width="50" data-height="50">ãƒ“ã‚¶ (50x50mm)</button>
            </div>
        </section>

        <!-- Step 2: Capture -->
        <section id="capture-section" class="step-section" style="display: none;">
            <h2 class="section-title">2. å†™çœŸã‚’æ’®å½±</h2>
            <p id="capture-instruction">é¡”ã‚’ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ã€1æšã®å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="camera-container">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="capture-canvas" style="display:none;"></canvas>
            </div>
            <div class="controls">
                <button id="capture-btn">æ’®å½±</button>
                <button id="back-to-size-btn">ã‚µã‚¤ã‚ºé¸æŠã«æˆ»ã‚‹</button>
            </div>
        </section>

        <!-- Step 3: Edit -->
        <section id="edit-section" class="step-section" style="display: none;">
            <h2 class="section-title">3. å†™çœŸã‚’ç·¨é›†</h2>
            <div class="editor-container">
                <div class="preview-container">
                    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <canvas id="editor-canvas"></canvas>
                </div>
                <div class="edit-controls">
                    <h3>ç·¨é›†ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                    <label for="bg-color">èƒŒæ™¯è‰²:</label>
                    <select id="bg-color">
                        <option value="#FFFFFF">ç™½</option>
                        <option value="#EBF4FF">é’</option>
                        <option value="#F3F4F6">ã‚°ãƒ¬ãƒ¼</option>
                    </select>
                    <label for="brightness">æ˜ã‚‹ã•: <span id="brightness-value">100</span>%</label>
                    <input type="range" id="brightness" min="50" max="150" value="100">
                    <label for="contrast">ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ: <span id="contrast-value">100</span>%</label>
                    <input type="range" id="contrast" min="50" max="150" value="100">
                    <button id="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
             <div class="controls">
                <button id="confirm-edit-btn">ã“ã®å†™çœŸã§æ±ºå®š</button>
                <button id="back-to-capture-btn">å†æ’®å½±</button>
            </div>
        </section>

        <!-- Step 4: Layout & Download -->
        <section id="layout-section" class="step-section" style="display: none;">
            <h2 class="section-title">4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
            <div id="photo-layout-container"></div>
            <div class="controls">
                <button id="download-btn">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button id="back-to-edit-btn">ç·¨é›†ã«æˆ»ã‚‹</button>
            </div>
        </section>

    </main>

    <script src="script.js"></script>
</body>
</html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pashatto Print - è¨¼æ˜å†™çœŸã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #0891b2, #06b6d4, #0284c7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1.2rem;
        }
        
        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            max-width: 800px;
            margin: 0 auto 40px;
        }
        
        .size-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .size-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            border-color: #0891b2;
        }
        
        .size-card.selected {
            border-color: #0891b2;
            background: #f0f9ff;
        }
        
        .size-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .size-desc {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .size-dimensions {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0891b2;
        }
        
        .camera-container {
            max-width: 400px;
            margin: 0 auto 20px;
        }
        
        .video-container {
            position: relative;
            aspect-ratio: 9/12;
            background: #f3f4f6;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        #video, #canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .face-guide {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 240px;
            border: 2px dashed white;
            border-radius: 8px;
            opacity: 0.7;
        }
        
        .face-oval {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 150px;
            border: 1px solid white;
            border-radius: 50%;
            opacity: 0.5;
        }
        
        .shoulder-guide {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 30px;
            border: 1px solid white;
            border-radius: 4px;
            opacity: 0.3;
        }
        
        .guide-text {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            text-align: center;
        }
        
        .guide-message {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .tips-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 24px;
            margin: 40px auto;
            max-width: 600px;
        }
        
        .tips-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }
        
        .tips-list {
            list-style: none;
            color: #4b5563;
        }
        
        .tips-list li {
            margin-bottom: 8px;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 0 20px;
        }
        
        .camera-buttons {
            position: sticky;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 16px;
            margin: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #0891b2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0e7490;
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }
        
        .section {
            margin-bottom: 60px;
        }
        
        .section-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .section-subtitle {
            color: #6b7280;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 40px;
        }
        
        .result-image {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        
        .result-image img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px 24px;
            border-radius: 12px;
            text-align: center;
            margin: 40px auto;
            max-width: 500px;
            font-weight: 600;
        }
        
        .edit-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .edit-preview {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .edit-controls {
            padding: 20px;
        }
        
        .edit-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .background-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .bg-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bg-option:hover {
            border-color: #0891b2;
            transform: translateY(-2px);
        }
        
        .bg-option.selected {
            border-color: #0891b2;
            background: #f0f9ff;
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2);
        }
        
        .bg-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .bg-option span {
            font-weight: 600;
            color: #374151;
        }
        
        .edit-tips {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }
        
        .edit-tips h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .edit-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .edit-tips li {
            margin-bottom: 8px;
            color: #4b5563;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 120px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .size-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .camera-container {
                max-width: 90vw;
                margin: 0 auto 10px;
            }
            
            .video-container {
                aspect-ratio: 3/4;
                margin-bottom: 10px;
            }
            
            .button-group {
                flex-direction: row;
                justify-content: center;
                gap: 12px;
                margin: 10px 0;
            }
            
            .btn {
                flex: 1;
                min-width: 0;
                max-width: 140px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .camera-buttons {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 16px 16px 0 0;
                padding: 20px;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
                z-index: 1000;
            }
            
            .tips-box {
                margin: 20px 16px;
                padding: 16px;
            }
            
            .face-guide {
                width: 160px;
                height: 200px;
                top: 15%;
            }
            
            .face-oval {
                width: 100px;
                height: 130px;
                top: 15px;
            }
            
            .shoulder-guide {
                width: 130px;
                height: 25px;
                bottom: 15px;
            }
            
            .section {
                margin-bottom: 30px;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .section-subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }
            
            .edit-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .edit-controls {
                padding: 16px;
            }
            
            .background-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .bg-option {
                padding: 12px;
            }
            
            .bg-preview {
                width: 50px;
                height: 50px;
            }
            
            .edit-tips {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1 class="title">Pashatto Print</h1>
            <p class="subtitle">ã„ã¤ã§ã‚‚ã€ã©ã“ã§ã‚‚ã€ç§ã®è¨¼æ˜å†™çœŸã‚¹ã‚¿ã‚¸ã‚ª</p>
        </div>

        <!-- ã‚µã‚¤ã‚ºé¸æŠç”»é¢ -->
        <div id="sizeSelector" class="section">
            <h2 class="section-title">è¨¼æ˜å†™çœŸã®ã‚µã‚¤ã‚ºã‚’é¸æŠ</h2>
            <p class="section-subtitle">ç”¨é€”ã«å¿œã˜ã¦æœ€é©ãªã‚µã‚¤ã‚ºã‚’ãŠé¸ã³ãã ã•ã„</p>
            
            <div class="size-grid">
                <div class="size-card" onclick="selectSize('resume')">
                    <div class="size-name">å±¥æ­´æ›¸ç”¨</div>
                    <div class="size-desc">å°±è·æ´»å‹•ãƒ»è»¢è·æ´»å‹•ã«</div>
                    <div class="size-dimensions">40 Ã— 30 mm</div>
                </div>
                
                <div class="size-card" onclick="selectSize('passport')">
                    <div class="size-name">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç”¨</div>
                    <div class="size-desc">æµ·å¤–æ¸¡èˆªç”³è«‹ã«</div>
                    <div class="size-dimensions">45 Ã— 35 mm</div>
                </div>
                
                <div class="size-card" onclick="selectSize('license')">
                    <div class="size-name">é‹è»¢å…è¨±è¨¼ç”¨</div>
                    <div class="size-desc">å…è¨±è¨¼æ›´æ–°ãƒ»æ–°è¦å–å¾—ã«</div>
                    <div class="size-dimensions">30 Ã— 24 mm</div>
                </div>
                
                <div class="size-card" onclick="selectSize('mynumber')">
                    <div class="size-name">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨</div>
                    <div class="size-desc">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ç”³è«‹ã«</div>
                    <div class="size-dimensions">45 Ã— 35 mm</div>
                </div>
            </div>
            
            <div style="text-align: center; color: #6b7280; font-size: 0.9rem; max-width: 600px; margin: 0 auto;">
                <p>â€» é¸æŠã—ãŸã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã€æ’®å½±æ™‚ã®ã‚¬ã‚¤ãƒ‰ãŒè‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™<br>
                â€» Lç‰ˆç”¨ç´™ï¼ˆ89mm Ã— 127mmï¼‰ã«æœ€é©ãªæšæ•°ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã™</p>
            </div>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©æ’®å½±ç”»é¢ -->
        <div id="cameraScreen" class="section hidden">
            <h2 class="section-title">å†™çœŸã‚’æ’®å½±</h2>
            <p class="section-subtitle" id="sizeInfo"></p>
            
            <div class="camera-container">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <div class="guide-overlay">
                        <div class="face-guide">
                            <div class="face-oval"></div>
                            <div class="shoulder-guide"></div>
                        </div>
                        <div class="guide-text">
                            <div class="guide-message">é¡”ã‚’ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åˆã‚ã›ã¦ãã ã•ã„</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tips-box">
                <div class="tips-title">ğŸ“¸ æ’®å½±ã®ã‚³ãƒ„</div>
                <ul class="tips-list">
                    <li>â€¢ æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„</li>
                    <li>â€¢ ç™½ã„å£ã®å‰ã«ç«‹ã£ã¦ãã ã•ã„</li>
                    <li>â€¢ æ­£é¢ã‚’å‘ã„ã¦ã€è‚©ã‚’å¹³è¡Œã«ä¿ã£ã¦ãã ã•ã„</li>
                    <li>â€¢ è¡¨æƒ…ã¯è‡ªç„¶ãªç¬‘é¡”ã¾ãŸã¯çœŸé¡”ã§</li>
                </ul>
            </div>
            
            <div class="camera-buttons">
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="backToSize()">â† æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="captureBtn" onclick="capture()">ğŸ“· æ’®å½±</button>
                    <button class="btn btn-secondary hidden" id="retakeBtn" onclick="retake()">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                    <button class="btn btn-success hidden" id="confirmBtn" onclick="confirm()">âœ“ æ±ºå®š</button>
                </div>
            </div>
        </div>

        <!-- ç·¨é›†ç”»é¢ -->
        <div id="editScreen" class="section hidden">
            <h2 class="section-title">å†™çœŸã‚’ç·¨é›†</h2>
            <p class="section-subtitle">èƒŒæ™¯è‰²ã‚’é¸æŠã—ã¦ã€è¨¼æ˜å†™çœŸã‚’ä»•ä¸Šã’ã¾ã—ã‚‡ã†</p>
            
            <div class="edit-container">
                <div class="edit-preview">
                    <div class="result-image">
                        <img id="editImage" src="" alt="ç·¨é›†ä¸­ã®å†™çœŸ">
                    </div>
                </div>
                
                <div class="edit-controls">
                    <h3 class="edit-title">èƒŒæ™¯è‰²ã‚’é¸æŠ</h3>
                    <div class="background-options">
                        <button class="bg-option bg-white selected" onclick="selectBackground('white')" data-bg="white">
                            <div class="bg-preview" style="background: #ffffff; border: 1px solid #ddd;"></div>
                            <span>ç™½</span>
                        </button>
                        <button class="bg-option bg-blue" onclick="selectBackground('blue')" data-bg="blue">
                            <div class="bg-preview" style="background: #e6f3ff;"></div>
                            <span>æ°´è‰²</span>
                        </button>
                        <button class="bg-option bg-gray" onclick="selectBackground('gray')" data-bg="gray">
                            <div class="bg-preview" style="background: #f5f5f5;"></div>
                            <span>ã‚°ãƒ¬ãƒ¼</span>
                        </button>
                        <button class="bg-option bg-original" onclick="selectBackground('original')" data-bg="original">
                            <div class="bg-preview" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px;"></div>
                            <span>å…ƒã®èƒŒæ™¯</span>
                        </button>
                    </div>
                    
                    <div class="edit-tips">
                        <h4>ğŸ’¡ èƒŒæ™¯è‰²ã®é¸ã³æ–¹</h4>
                        <ul>
                            <li><strong>ç™½</strong>: å±¥æ­´æ›¸ã€ä¸€èˆ¬çš„ãªè¨¼æ˜æ›¸é¡</li>
                            <li><strong>æ°´è‰²</strong>: ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã€å›½éš›çš„ãªæ›¸é¡</li>
                            <li><strong>ã‚°ãƒ¬ãƒ¼</strong>: é‹è»¢å…è¨±è¨¼ã€å…¬çš„æ›¸é¡</li>
                            <li><strong>å…ƒã®èƒŒæ™¯</strong>: è‡ªç„¶ãªä»•ä¸ŠãŒã‚Š</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToCamera()">â† æ’®å½±ã«æˆ»ã‚‹</button>
                <button class="btn btn-primary" onclick="finishEdit()">âœ“ ç·¨é›†å®Œäº†</button>
            </div>
        </div>

        <!-- å®Œäº†ç”»é¢ -->
        <div id="completeScreen" class="section hidden">
            <h2 class="section-title">è¨¼æ˜å†™çœŸå®Œæˆï¼</h2>
            <p class="section-subtitle">Lç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ</p>
            
            <div class="result-image">
                <img id="finalImage" src="" alt="å®Œæˆã—ãŸè¨¼æ˜å†™çœŸ">
            </div>
            
            <div class="tips-box">
                <div class="tips-title">ğŸ–¨ï¸ å°åˆ·ã‚¬ã‚¤ãƒ‰</div>
                <div style="color: #4b5563;">
                    <div style="margin-bottom: 16px;">
                        <strong>è‡ªå®…ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã®å ´åˆï¼š</strong>
                        <ul class="tips-list" style="margin-left: 16px; margin-top: 8px;">
                            <li>â€¢ ç”¨ç´™è¨­å®šï¼šLç‰ˆï¼ˆ89mm Ã— 127mmï¼‰</li>
                            <li>â€¢ å°åˆ·å“è³ªï¼šé«˜å“è³ªã¾ãŸã¯å†™çœŸå“è³ª</li>
                            <li>â€¢ ç”¨ç´™ç¨®é¡ï¼šå†™çœŸç”¨ç´™ï¼ˆå…‰æ²¢ã¾ãŸã¯ãƒãƒƒãƒˆï¼‰</li>
                            <li>â€¢ ä½™ç™½è¨­å®šï¼šä½™ç™½ãªã—ï¼ˆãƒ•ãƒãªã—å°åˆ·ï¼‰</li>
                        </ul>
                    </div>
                    <div>
                        <strong>ã‚³ãƒ³ãƒ“ãƒ‹ãƒ—ãƒªãƒ³ãƒˆã®å ´åˆï¼š</strong>
                        <ul class="tips-list" style="margin-left: 16px; margin-top: 8px;">
                            <li>â€¢ USBãƒ¡ãƒ¢ãƒªã‚„ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã§ç”»åƒã‚’æŒå‚</li>
                            <li>â€¢ Lç‰ˆã‚µã‚¤ã‚ºã‚’é¸æŠ</li>
                            <li>â€¢ å†™çœŸç”¨ç´™ã§å°åˆ·</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="downloadImage()">ğŸ’¾ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-secondary" onclick="startOver()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
            </div>
            
            <div class="success-message">
                ğŸ‰ è¨¼æ˜å†™çœŸã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼
            </div>
        </div>
    </div>

    <script>
        let selectedPhotoSize = '';
        let video, canvas, capturedImage, editedImage;
        let selectedBackground = 'white';
        
        const photoSizes = {
            resume: { name: 'å±¥æ­´æ›¸ç”¨', width: 30, height: 40, count: 6 },
            passport: { name: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç”¨', width: 35, height: 45, count: 4 },
            license: { name: 'é‹è»¢å…è¨±è¨¼ç”¨', width: 24, height: 30, count: 8 },
            mynumber: { name: 'ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨', width: 35, height: 45, count: 4 }
        };
        
        const backgroundColors = {
            white: '#ffffff',
            blue: '#e6f3ff',
            gray: '#f5f5f5',
            original: null
        };

        function selectSize(size) {
            // é¸æŠçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
            document.querySelectorAll('.size-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.size-card').classList.add('selected');
            
            selectedPhotoSize = size;
            const sizeInfo = photoSizes[size];
            document.getElementById('sizeInfo').textContent = `${sizeInfo.name} (${sizeInfo.width}mm Ã— ${sizeInfo.height}mm)`;
            
            setTimeout(() => {
                document.getElementById('sizeSelector').classList.add('hidden');
                document.getElementById('cameraScreen').classList.remove('hidden');
                startCamera();
            }, 300);
        }

        function backToSize() {
            document.getElementById('cameraScreen').classList.add('hidden');
            document.getElementById('sizeSelector').classList.remove('hidden');
            stopCamera();
        }

        function startCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(error) {
                        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
                        alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                    });
            } else {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function stopCamera() {
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function capture() {
            try {
                console.log('Capture function called');
                
                if (!video || !video.videoWidth || !video.videoHeight) {
                    console.error('Video not ready:', video);
                    alert('ã‚«ãƒ¡ãƒ©ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    return;
                }
                
                if (!canvas) {
                    console.error('Canvas not found');
                    return;
                }
                
                const context = canvas.getContext('2d');
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªæ’®å½±å‡¦ç†ã«æˆ»ã™
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                capturedImage = canvas.toDataURL('image/jpeg', 0.9);
                console.log('Image captured successfully');
                
                // UIã‚’æ›´æ–°
                video.classList.add('hidden');
                canvas.classList.remove('hidden');
                
                const captureBtn = document.getElementById('captureBtn');
                const retakeBtn = document.getElementById('retakeBtn');
                const confirmBtn = document.getElementById('confirmBtn');
                
                if (captureBtn) captureBtn.classList.add('hidden');
                if (retakeBtn) retakeBtn.classList.remove('hidden');
                if (confirmBtn) confirmBtn.classList.remove('hidden');
                
                console.log('UI updated successfully');
                
            } catch (error) {
                console.error('Error in capture function:', error);
                alert('æ’®å½±ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function retake() {
            video.classList.remove('hidden');
            canvas.classList.add('hidden');
            
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('confirmBtn').classList.add('hidden');
        }

        function confirm() {
            document.getElementById('cameraScreen').classList.add('hidden');
            document.getElementById('editScreen').classList.remove('hidden');
            document.getElementById('editImage').src = capturedImage;
            editedImage = capturedImage; // åˆæœŸçŠ¶æ…‹ã§ã¯å…ƒç”»åƒ
            stopCamera();
        }
        
        function selectBackground(bgType) {
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.bg-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-bg="${bgType}"]`).classList.add('selected');
            
            selectedBackground = bgType;
            
            // èƒŒæ™¯å‡¦ç†ã‚’é©ç”¨
            applyBackground(capturedImage, bgType);
        }
        
        function applyBackground(imageSrc, bgType) {
            const editImageElement = document.getElementById('editImage');
            
            if (bgType === 'original') {
                // å…ƒã®èƒŒæ™¯ã‚’ãã®ã¾ã¾ä½¿ç”¨
                editedImage = imageSrc;
                editImageElement.src = editedImage;
                return;
            }
            
            try {
                // èƒŒæ™¯å‡¦ç†ç”¨ã®Canvasã‚’ä½œæˆ
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const img = new Image();
                img.onload = function() {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // äººç‰©é ˜åŸŸã‚’æŠ½å‡ºã—ã¦èƒŒæ™¯ã‚’ç½®ãæ›ãˆ
                        const processedImageData = removeBackground(img, backgroundColors[bgType]);
                        
                        // å‡¦ç†ã—ãŸç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
                        ctx.putImageData(processedImageData, 0, 0);
                        
                        // çµæœã‚’ä¿å­˜
                        editedImage = canvas.toDataURL('image/jpeg', 0.9);
                        editImageElement.src = editedImage;
                        
                        console.log('Background removed and replaced:', bgType);
                    } catch (error) {
                        console.error('Error in image processing:', error);
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒç”»åƒã‚’è¡¨ç¤º
                        editImageElement.src = imageSrc;
                    }
                };
                
                img.onerror = function() {
                    console.error('Error loading image');
                    editImageElement.src = imageSrc;
                };
                
                img.src = imageSrc;
                
            } catch (error) {
                console.error('Error in applyBackground:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒç”»åƒã‚’è¡¨ç¤º
                editImageElement.src = imageSrc;
            }
        }
        
        // é«˜åº¦ãªèƒŒæ™¯é™¤å»å‡¦ç†
        function removeBackground(img, bgColor) {
            // ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã§ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            const data = imageData.data;
            const width = img.width;
            const height = img.height;
            
            // èƒŒæ™¯è‰²ã®RGBå€¤ã‚’å–å¾—
            const bgRgb = hexToRgb(bgColor);
            
            // äººç‰©é ˜åŸŸã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®ãƒã‚¹ã‚¯ã‚’ä½œæˆ
            const personMask = createPersonMask(data, width, height);
            
            // ãƒã‚¹ã‚¯ã‚’ä½¿ç”¨ã—ã¦èƒŒæ™¯ã‚’ç½®ãæ›ãˆ
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    
                    // äººç‰©é ˜åŸŸã§ãªã„å ´åˆã¯èƒŒæ™¯è‰²ã«ç½®ãæ›ãˆ
                    if (!personMask[y * width + x]) {
                        data[index] = bgRgb.r;     // R
                        data[index + 1] = bgRgb.g; // G
                        data[index + 2] = bgRgb.b; // B
                        // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã¯ãã®ã¾ã¾
                    } else {
                        // äººç‰©é ˜åŸŸã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’å¼·åŒ–
                        const factor = 1.1;
                        data[index] = Math.min(255, data[index] * factor);
                        data[index + 1] = Math.min(255, data[index + 1] * factor);
                        data[index + 2] = Math.min(255, data[index + 2] * factor);
                    }
                }
            }
            
            return imageData;
        }
        
        // äººç‰©é ˜åŸŸã‚’æ¤œå‡ºã™ã‚‹ãƒã‚¹ã‚¯ã‚’ä½œæˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function createPersonMask(data, width, height) {
            const mask = new Array(width * height).fill(false);
            
            // ã‚¹ãƒ†ãƒƒãƒ—1: èƒŒæ™¯è‰²ã‚’åˆ†æ
            const backgroundColors = analyzeBackgroundColors(data, width, height);
            
            // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¨ãƒƒã‚¸æ¤œå‡ºã§è¼ªéƒ­ã‚’ç‰¹å®š
            const edges = detectEdges(data, width, height);
            
            // ã‚¹ãƒ†ãƒƒãƒ—3: è‰²ç›¸ãƒ»å½©åº¦ãƒ»æ˜åº¦ã«ã‚ˆã‚‹äººç‰©é ˜åŸŸæ¤œå‡º
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    
                    // èƒŒæ™¯è‰²ã¨ã®å·®ç•°ã‚’è¨ˆç®—
                    const isBackground = isBackgroundColor(r, g, b, backgroundColors);
                    
                    // äººç‰©ã‚‰ã—ã„ç‰¹å¾´ã‚’æ¤œå‡º
                    const isSkinTone = detectSkinTone(r, g, b);
                    const isHair = detectHair(r, g, b);
                    const isClothing = detectClothing(r, g, b);
                    const hasEdge = edges[y * width + x];
                    
                    // è¤‡æ•°ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ã¦åˆ¤å®š
                    const personScore = calculatePersonScore({
                        isSkinTone,
                        isHair,
                        isClothing,
                        hasEdge,
                        isBackground,
                        x, y, width, height
                    });
                    
                    if (personScore > 0.3) {
                        mask[y * width + x] = true;
                    }
                }
            }
            
            // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¢ãƒ«ãƒ•ã‚©ãƒ­ã‚¸ãƒ¼å‡¦ç†ã§ãƒã‚¤ã‚ºé™¤å»
            const cleanedMask = morphologyClean(mask, width, height);
            
            // ã‚¹ãƒ†ãƒƒãƒ—5: é€£çµæˆåˆ†åˆ†æã§æœ€å¤§é ˜åŸŸã‚’æŠ½å‡º
            return extractLargestComponent(cleanedMask, width, height);
        }
        
        // èƒŒæ™¯è‰²ã‚’åˆ†æ
        function analyzeBackgroundColors(data, width, height) {
            const colorCounts = new Map();
            const borderPixels = [];
            
            // ç”»åƒã®ç«¯ã®è‰²ã‚’åé›†
            for (let x = 0; x < width; x++) {
                borderPixels.push({r: data[x * 4], g: data[x * 4 + 1], b: data[x * 4 + 2]}); // ä¸Šç«¯
                borderPixels.push({r: data[((height-1) * width + x) * 4], g: data[((height-1) * width + x) * 4 + 1], b: data[((height-1) * width + x) * 4 + 2]}); // ä¸‹ç«¯
            }
            for (let y = 0; y < height; y++) {
                borderPixels.push({r: data[y * width * 4], g: data[y * width * 4 + 1], b: data[y * width * 4 + 2]}); // å·¦ç«¯
                borderPixels.push({r: data[(y * width + width - 1) * 4], g: data[(y * width + width - 1) * 4 + 1], b: data[(y * width + width - 1) * 4 + 2]}); // å³ç«¯
            }
            
            // æœ€ã‚‚å¤šã„è‰²ã‚’èƒŒæ™¯è‰²ã¨ã—ã¦ç‰¹å®š
            borderPixels.forEach(pixel => {
                const key = `${Math.floor(pixel.r/10)*10},${Math.floor(pixel.g/10)*10},${Math.floor(pixel.b/10)*10}`;
                colorCounts.set(key, (colorCounts.get(key) || 0) + 1);
            });
            
            const dominantColor = Array.from(colorCounts.entries()).sort((a, b) => b[1] - a[1])[0];
            const [r, g, b] = dominantColor[0].split(',').map(Number);
            
            return {r, g, b};
        }
        
        // ã‚¨ãƒƒã‚¸æ¤œå‡º
        function detectEdges(data, width, height) {
            const edges = new Array(width * height).fill(false);
            const threshold = 30;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const index = (y * width + x) * 4;
                    const current = data[index] + data[index + 1] + data[index + 2];
                    
                    // å‘¨å›²8ãƒ”ã‚¯ã‚»ãƒ«ã¨ã®å·®åˆ†ã‚’è¨ˆç®—
                    let maxDiff = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            const neighborIndex = ((y + dy) * width + (x + dx)) * 4;
                            const neighbor = data[neighborIndex] + data[neighborIndex + 1] + data[neighborIndex + 2];
                            maxDiff = Math.max(maxDiff, Math.abs(current - neighbor));
                        }
                    }
                    
                    edges[y * width + x] = maxDiff > threshold;
                }
            }
            
            return edges;
        }
        
        // èƒŒæ™¯è‰²ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isBackgroundColor(r, g, b, bgColor) {
            const threshold = 40;
            const distance = Math.sqrt(
                Math.pow(r - bgColor.r, 2) + 
                Math.pow(g - bgColor.g, 2) + 
                Math.pow(b - bgColor.b, 2)
            );
            return distance < threshold;
        }
        
        // äººç‰©ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
        function calculatePersonScore({isSkinTone, isHair, isClothing, hasEdge, isBackground, x, y, width, height}) {
            let score = 0;
            
            // ä¸­å¤®ã«è¿‘ã„ã»ã©é«˜ã‚¹ã‚³ã‚¢
            const centerX = width / 2;
            const centerY = height / 2;
            const distanceFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            const maxDistance = Math.sqrt(Math.pow(centerX, 2) + Math.pow(centerY, 2));
            const centerScore = 1 - (distanceFromCenter / maxDistance);
            
            if (isSkinTone) score += 0.8;
            if (isHair) score += 0.6;
            if (isClothing) score += 0.4;
            if (hasEdge) score += 0.3;
            if (isBackground) score -= 0.9;
            
            score += centerScore * 0.2;
            
            return Math.max(0, Math.min(1, score));
        }
        
        // ãƒ¢ãƒ«ãƒ•ã‚©ãƒ­ã‚¸ãƒ¼å‡¦ç†ã§ãƒã‚¤ã‚ºé™¤å»
        function morphologyClean(mask, width, height) {
            const cleaned = [...mask];
            const kernelSize = 3;
            const halfKernel = Math.floor(kernelSize / 2);
            
            // ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†ï¼ˆå°ã•ãªç©´ã‚’åŸ‹ã‚ã‚‹ï¼‰
            for (let y = halfKernel; y < height - halfKernel; y++) {
                for (let x = halfKernel; x < width - halfKernel; x++) {
                    let trueCount = 0;
                    for (let dy = -halfKernel; dy <= halfKernel; dy++) {
                        for (let dx = -halfKernel; dx <= halfKernel; dx++) {
                            if (mask[(y + dy) * width + (x + dx)]) trueCount++;
                        }
                    }
                    if (trueCount >= kernelSize * kernelSize * 0.6) {
                        cleaned[y * width + x] = true;
                    }
                }
            }
            
            return cleaned;
        }
        
        // æœ€å¤§é€£çµæˆåˆ†ã‚’æŠ½å‡º
        function extractLargestComponent(mask, width, height) {
            const visited = new Array(width * height).fill(false);
            const components = [];
            
            function floodFill(startX, startY) {
                const stack = [{x: startX, y: startY}];
                const component = [];
                
                while (stack.length > 0) {
                    const {x, y} = stack.pop();
                    if (x < 0 || x >= width || y < 0 || y >= height) continue;
                    if (visited[y * width + x] || !mask[y * width + x]) continue;
                    
                    visited[y * width + x] = true;
                    component.push({x, y});
                    
                    stack.push({x: x+1, y}, {x: x-1, y}, {x, y: y+1}, {x, y: y-1});
                }
                
                return component;
            }
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    if (mask[y * width + x] && !visited[y * width + x]) {
                        const component = floodFill(x, y);
                        if (component.length > 100) { // æœ€å°ã‚µã‚¤ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                            components.push(component);
                        }
                    }
                }
            }
            
            // æœ€å¤§æˆåˆ†ã‚’é¸æŠ
            if (components.length === 0) return mask;
            
            const largestComponent = components.reduce((max, current) => 
                current.length > max.length ? current : max
            );
            
            const result = new Array(width * height).fill(false);
            largestComponent.forEach(({x, y}) => {
                result[y * width + x] = true;
            });
            
            return result;
        }
        
        // è‚‰è‰²ã‚’æ¤œå‡º
        function detectSkinTone(r, g, b) {
            // è‚‰è‰²ã®ç¯„å›²ã‚’å®šç¾©ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            return (r > 95 && g > 40 && b > 20 && 
                    r > g && r > b && 
                    Math.abs(r - g) > 15 && 
                    r - b > 15);
        }
        
        // é«ªã®è‰²ã‚’æ¤œå‡º
        function detectHair(r, g, b) {
            const brightness = (r + g + b) / 3;
            // æš—ã„è‰²ï¼ˆé»’é«ªã€èŒ¶é«ªï¼‰ã¾ãŸã¯æ˜ã‚‹ã„è‰²ï¼ˆé‡‘é«ªï¼‰
            return brightness < 80 || (r > 150 && g > 120 && b < 100);
        }
        
        // æœã®è‰²ã‚’æ¤œå‡º
        function detectClothing(r, g, b, brightness) {
            // ä¸€èˆ¬çš„ãªæœã®è‰²ç¯„å›²ï¼ˆèƒŒæ™¯ã¨ã¯ç•°ãªã‚‹è‰²ï¼‰
            return brightness > 50 && brightness < 200 && 
                   (Math.abs(r - g) > 20 || Math.abs(g - b) > 20 || Math.abs(r - b) > 20);
        }
        
        // ãƒã‚¹ã‚¯ã‚’æ‹¡å¼µã—ã¦ã‚¨ãƒƒã‚¸ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹
        function expandMask(mask, centerX, centerY, width, height, radius) {
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const x = centerX + dx;
                    const y = centerY + dy;
                    if (x >= 0 && x < width && y >= 0 && y < height) {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance <= radius) {
                            mask[y * width + x] = true;
                        }
                    }
                }
            }
        }
        
        // 16é€²æ•°è‰²ã‚’RGBã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        

        
        function backToCamera() {
            document.getElementById('editScreen').classList.add('hidden');
            document.getElementById('cameraScreen').classList.remove('hidden');
            
            // ã‚«ãƒ¡ãƒ©çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            retake();
        }
        
        function finishEdit() {
            document.getElementById('editScreen').classList.add('hidden');
            document.getElementById('completeScreen').classList.remove('hidden');
            
            // Lç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç”Ÿæˆ
            generateLSizeLayout(editedImage, selectedPhotoSize);
        }

        function downloadImage() {
            if (!capturedImage) {
                alert('ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // Lç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”»åƒã‚’ç”Ÿæˆ
            generateLSizeLayout(capturedImage, selectedPhotoSize);
        }
        
        function generateLSizeLayout(imageSrc, sizeKey) {
            const sizeInfo = photoSizes[sizeKey];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Lç‰ˆã‚µã‚¤ã‚ºï¼ˆ89mm Ã— 127mmï¼‰ã‚’300DPIã§ãƒ”ã‚¯ã‚»ãƒ«å¤‰æ›
            const dpi = 300;
            const lSizeWidthPx = Math.round((89 / 25.4) * dpi);  // ç´„1051px
            const lSizeHeightPx = Math.round((127 / 25.4) * dpi); // ç´„1500px
            
            canvas.width = lSizeWidthPx;
            canvas.height = lSizeHeightPx;
            
            // ç™½èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // è¨¼æ˜å†™çœŸã‚µã‚¤ã‚ºã‚’ãƒ”ã‚¯ã‚»ãƒ«å¤‰æ›
            const photoWidthPx = Math.round((sizeInfo.width / 25.4) * dpi);
            const photoHeightPx = Math.round((sizeInfo.height / 25.4) * dpi);
            
            const img = new Image();
            img.onload = function() {
                // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—
                const margin = Math.round((3 / 25.4) * dpi); // 3mmãƒãƒ¼ã‚¸ãƒ³
                const cols = Math.floor((canvas.width - margin) / (photoWidthPx + margin));
                const rows = Math.floor((canvas.height - margin) / (photoHeightPx + margin));
                const maxPhotos = Math.min(cols * rows, sizeInfo.count);
                
                // ä¸­å¤®æƒãˆã®ãŸã‚ã®é–‹å§‹ä½ç½®è¨ˆç®—
                const actualCols = Math.min(cols, maxPhotos);
                const actualRows = Math.ceil(maxPhotos / actualCols);
                const totalWidth = actualCols * photoWidthPx + (actualCols - 1) * margin;
                const totalHeight = actualRows * photoHeightPx + (actualRows - 1) * margin;
                const startX = (canvas.width - totalWidth) / 2;
                const startY = (canvas.height - totalHeight) / 2;
                
                // å†™çœŸã‚’é…ç½®
                for (let i = 0; i < maxPhotos; i++) {
                    const col = i % actualCols;
                    const row = Math.floor(i / actualCols);
                    const x = startX + col * (photoWidthPx + margin);
                    const y = startY + row * (photoHeightPx + margin);
                    
                    // å†™çœŸã‚’æç”»ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒˆãƒªãƒŸãƒ³ã‚°ï¼‰
                    const scale = Math.max(photoWidthPx / img.width, photoHeightPx / img.height);
                    const scaledWidth = img.width * scale;
                    const scaledHeight = img.height * scale;
                    const offsetX = (scaledWidth - photoWidthPx) / 2;
                    const offsetY = (scaledHeight - photoHeightPx) / 2;
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.rect(x, y, photoWidthPx, photoHeightPx);
                    ctx.clip();
                    ctx.drawImage(img, x - offsetX, y - offsetY, scaledWidth, scaledHeight);
                    ctx.restore();
                    
                    // ãƒˆãƒ³ãƒœï¼ˆåˆ‡ã‚Šå–ã‚Šç·šï¼‰ã‚’æç”»
                    ctx.strokeStyle = '#cccccc';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                    ctx.strokeRect(x, y, photoWidthPx, photoHeightPx);
                    ctx.setLineDash([]);
                }
                
                // Lç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const layoutDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                link.download = `è¨¼æ˜å†™çœŸ_Lç‰ˆ_${sizeInfo.name}_${sizeInfo.count}æš_${date}.jpg`;
                link.href = layoutDataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
                updateLayoutPreview(layoutDataUrl, sizeInfo);
            };
            
            img.src = imageSrc;
        }
        
        function updateLayoutPreview(layoutImageSrc, sizeInfo) {
            const finalImage = document.getElementById('finalImage');
            finalImage.src = layoutImageSrc;
            
            // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            const successMessage = document.querySelector('.success-message');
            successMessage.innerHTML = `ğŸ‰ Lç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Œæˆã—ã¾ã—ãŸï¼${sizeInfo.name} ${sizeInfo.count}æšé…ç½®`;
        }

        function startOver() {
            document.getElementById('completeScreen').classList.add('hidden');
            document.getElementById('sizeSelector').classList.remove('hidden');
            
            // ãƒªã‚»ãƒƒãƒˆ
            selectedPhotoSize = '';
            capturedImage = '';
            
            // é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.size-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('confirmBtn').classList.add('hidden');
            
            video.classList.remove('hidden');
            canvas.classList.add('hidden');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Pashatto Print ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        });
    </script>
</body>
</html>
